# 关于InnoDB的flush method

1. 

> 参考：[细看INNODB数据落盘](http://www.kuqin.com/shuoit/20141019/342744.html?utm_source=tuicool&utm_medium=referral)

>||Open log|Flush log|Open datafile|Flush data|
|---|---|---|---|---|
|Fdatasync||fsync()||fsync()|
|O_DSYNC|O_SYNC|||fsync()|
|O_DIRECT||fsync()|O_DIRECT|Fsync()|
|O_DIRECT_NO_FSYNC||fsync()|O_DIRECT||
All_O_DIRECT(percona)|O_DIRECT|fsync()|O_DIRECT|fsync|

> [[db_005_p1.png|width=768px]]

2.
> 参考：[MySQL文档中对于innodb_flush_method的说明](https://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html#sysvar_innodb_flush_method)

>How each settings affects performance depends on hardware configuration and workload. Benchmark your particular configuration to decide which setting to use, or whether to keep the default setting. Examine the *Innodb_data_fsyncs* status variable to see the overall number of fsync() calls for each setting. The mix of read and write operations in your workload can affect how a setting performs. For example, on a system with a hardware RAID controller and battery-backed write cache, O_DIRECT can help to avoid double buffering between the InnoDB buffer pool and the operating system's file system cache. On some systems where InnoDB data and log files are located on a SAN, the default value or O_DSYNC might be faster for a read-heavy workload with mostly SELECT statements. Always test this parameter with hardware and workload that reflect your production environment. 

这段说明，用哪种flush设置取决于具体的硬件配置和工作负载，比如在有硬件RAID控制器和电源备份写cache的情况下，用O_DIRECT可以帮助系统避免InnoDB和OS的两层buffer/cache；在一些在SAN中的InnoDB数据的情况下，读负载要更加繁重，SELECT操作更多一些，这时用默认的fsync()或者O_DSYNC会更快一些。


 
||page cache|buffer cache|inode cache|dictory cache|
|---|---|---|---|---|
|O_DIRECT|write bypass|write bypass|write & no flush|write & no flush|
|O_DSYNC/fdatasync()|write & flush|write & flush|write & no flush|write & no flush|
|O_SYNC/fsync()|write & flush|write & flush|write & flush|write & flush|


> [MySQL文档中关于bufferpool冲洗的内容 Configuring InnoDB Buffer Pool Flushing](https://dev.mysql.com/doc/refman/5.7/en/innodb-performance-adaptive_flushing.html)

> [MySQL文档中关于bufferpool冲洗优化的内容 Fine-tuning InnoDB Buffer Pool Flushing](https://dev.mysql.com/doc/refman/5.7/en/innodb-lru-background-flushing.html)

>[MySQL文档中关于磁盘IO优化的内容 Optimizing InnoDB Disk I/O](https://dev.mysql.com/doc/refman/5.7/en/optimizing-innodb-diskio.html)

>[Linux fflush 与 fsync的区别](http://blog.csdn.net/cindy9902/article/details/5827183)

>[O_DIRECT vs. O_SYNC on Linux/FreeBSD](http://stackoverflow.com/questions/19440041/o-direct-vs-o-sync-on-linux-freebsd)

>[open()函数man page](http://man7.org/linux/man-pages/man2/open.2.html)

